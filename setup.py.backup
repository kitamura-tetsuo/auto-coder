"""
Custom setup.py to build TypeScript graph-builder before packaging.

This ensures that the TypeScript version of graph-builder is compiled
before the Python package is built, so that the dist/ directory is
included in the package.
"""

import os
import subprocess
import sys
from pathlib import Path

from setuptools import setup
from setuptools.command.build_py import build_py
from setuptools.command.develop import develop
from setuptools.command.sdist import sdist


class BuildGraphBuilder:
    """Mixin class to build TypeScript graph-builder."""

    def build_graph_builder(self) -> None:
        """Build TypeScript graph-builder using npm."""
        graph_builder_dir = Path(__file__).parent / "src" / "auto_coder" / "graph_builder"

        if not graph_builder_dir.exists():
            print(
                f"Warning: graph_builder directory not found at {graph_builder_dir}",
                file=sys.stderr,
            )
            return

        package_json = graph_builder_dir / "package.json"
        if not package_json.exists():
            print(
                f"Warning: package.json not found at {package_json}",
                file=sys.stderr,
            )
            return

        print("=" * 70)
        print("Building TypeScript graph-builder...")
        print("=" * 70)

        # Check if npm is available
        try:
            subprocess.run(
                ["npm", "--version"],
                check=True,
                capture_output=True,
                cwd=graph_builder_dir,
            )
        except (subprocess.CalledProcessError, FileNotFoundError):
            print(
                "Warning: npm not found. Skipping TypeScript build.",
                file=sys.stderr,
            )
            print(
                "The TypeScript version of graph-builder will not be available.",
                file=sys.stderr,
            )
            return

        # Install dependencies if node_modules doesn't exist
        node_modules = graph_builder_dir / "node_modules"
        if not node_modules.exists():
            print("Installing npm dependencies...")
            try:
                subprocess.run(
                    ["npm", "install"],
                    check=True,
                    cwd=graph_builder_dir,
                )
            except subprocess.CalledProcessError as e:
                print(
                    f"Warning: npm install failed: {e}",
                    file=sys.stderr,
                )
                return

        # Build TypeScript
        print("Compiling TypeScript...")
        try:
            subprocess.run(
                ["npm", "run", "build"],
                check=True,
                cwd=graph_builder_dir,
            )
            print("TypeScript build completed successfully!")
        except subprocess.CalledProcessError as e:
            print(
                f"Warning: TypeScript build failed: {e}",
                file=sys.stderr,
            )
            print(
                "The TypeScript version of graph-builder will not be available.",
                file=sys.stderr,
            )


class CustomBuildPy(build_py, BuildGraphBuilder):
    """Custom build_py command that builds TypeScript before building Python package."""

    def run(self) -> None:
        """Run the build."""
        self.build_graph_builder()
        super().run()


class CustomDevelop(develop, BuildGraphBuilder):
    """Custom develop command that builds TypeScript in development mode."""

    def run(self) -> None:
        """Run the develop installation."""
        self.build_graph_builder()
        super().run()


class CustomSdist(sdist, BuildGraphBuilder):
    """Custom sdist command that builds TypeScript before creating source distribution."""

    def run(self) -> None:
        """Run the source distribution creation."""
        self.build_graph_builder()
        super().run()


# Use setup() with cmdclass to override build commands
setup(
    name="auto-coder",
    version="2025.11.4.12+g7b21653",
    description="Automated application development using Gemini CLI and GitHub integration",
    readme="README.md",
    license_file="LICENSE",
    author="Auto-Coder Team",
    python_requires=">=3.11,<3.12",
    install_requires=[
        "requests>=2.31.0",
        "pydantic>=2.0.0,<3.0.0",
        "pydantic-settings>=2.0.0",
        "click>=8.1.0",
        "python-dotenv>=1.0.0",
        "PyGithub>=1.59.0",
        "pyyaml>=6.0",
        "GitPython>=3.1.0",
        "loguru>=0.7.0",
        "neo4j>=5.14.0",
        "qdrant-client>=1.7.0",
        "sentence-transformers>=2.2.0",
        "watchdog>=6.0.0",
        "pathspec>=0.12.0",
        "playwright>=1.54.0",
        "mcp-server>=0.1.4",
    ],
    packages=["auto_coder", "auto_coder.util"],
    package_dir={"": "src"},
    package_data={
        "auto_coder": ["prompts.yaml", "*.yml", "*.yaml"],
    },
    # Keep entry_points in setup.py for pipx compatibility
    entry_points={
        "console_scripts": [
            "auto-coder=auto_coder.cli:main",
        ],
    },
    cmdclass={
        "build_py": CustomBuildPy,
        "develop": CustomDevelop,
        "sdist": CustomSdist,
    }
)

