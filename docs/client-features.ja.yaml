version: "2025.11.3.33+gd77cf97"
project:
  name: auto-coder
  description: 複数バックエンドLLM CLIとGitHub連携による自動アプリ開発
  python: ">=3.11,<3.12"
  entry_point: auto-coder
  repository_paths:
    - "mcp/graphrag_mcp"  # バンドルされた GraphRAG MCP フォークのパス

cli:
  binary: auto-coder
  commands:
    - name: process-issues
      purpose: GitHub の Issue/PR をAIで処理。JulesモードではIssueにラベル付与のみ
      options:
        - { name: --repo, type: string, default: 現在のgitリポジトリから自動検出 }
        - { name: --github-token, type: string, env: GITHUB_TOKEN }
        - { name: --backend, multiple: true, default: [codex], choices: [codex, codex-mcp, gemini, qwen, auggie, claude] }
        - { name: --message-backend, multiple: true, default: --backendと同じ, choices: [codex, codex-mcp, gemini, qwen, auggie, claude] }
        - { name: --gemini-api-key, env: GEMINI_API_KEY }
        - { name: --openai-api-key, env: OPENAI_API_KEY }
        - { name: --openai-base-url, env: OPENAI_BASE_URL }
        - { name: --qwen-use-env-vars/--qwen-use-cli-options, default: false }
        - { name: --qwen-preserve-env/--qwen-clear-env, default: false }
        - { name: --model-gemini }
        - { name: --model-qwen }
        - { name: --model-auggie }
        - { name: --model-claude }
        - { name: --dry-run, flag: true, default: false }
        - { name: --jules-mode/--no-jules-mode, default: true }
        - { name: --disable-labels/--no-disable-labels, default: 自動検出(デバッガ時は無効) }
        - { name: --skip-main-update/--no-skip-main-update, default: true }
        - { name: --ignore-dependabot-prs/--no-ignore-dependabot-prs, default: false }
        - { name: --force-clean-before-checkout/--no-force-clean-before-checkout, default: false }
        - { name: --enable-graphrag/--disable-graphrag, default: true }
        - { name: --only, type: string, help: "PR/IssueのURLまたは番号" }
        - { name: --force-reindex, flag: true, default: false }
        - { name: --log-level, choices: [DEBUG, INFO, WARNING, ERROR, CRITICAL], default: INFO }
        - { name: --log-file, type: path }
        - { name: --verbose, flag: true }
      behavior:
        - 有効時はGraphRAGを初期化（自動セットアップ + MCP設定チェック）
        - main以外のブランチ上では、対応するPR/Issueを検出して作業を自動再開
        - 候補優先度: urgent(3) > 自動マージ可PR(2) > 失敗PR(1) > Issue(0)
        - 未サブIssueのオープンIssueが5件以上ある場合、Issue処理を一時スキップ
        - レポートJSONを ~/.auto-coder/{owner_repo}/ に保存
        - PR失敗時のベースマージは既定でスキップ（--no-skip-main-updateで無効化）
    - name: create-feature-issues
      purpose: リポジトリを解析し、機能追加Issueを構造化して作成
      options:
        - { name: --repo, type: string, default: 自動検出 }
        - { name: --github-token, env: GITHUB_TOKEN }
        - { name: --backend, multiple: true, default: [codex], choices: [codex, codex-mcp, gemini, qwen, auggie, claude] }
        - { name: --gemini-api-key, env: GEMINI_API_KEY }
        - { name: --openai-api-key, env: OPENAI_API_KEY }
        - { name: --openai-base-url, env: OPENAI_BASE_URL }
        - { name: --qwen-use-env-vars/--qwen-use-cli-options, default: true }
        - { name: --qwen-preserve-env/--qwen-clear-env, default: false }
        - { name: --model-gemini }
        - { name: --model-qwen }
        - { name: --model-auggie }
        - { name: --model-claude }
        - { name: --enable-graphrag/--disable-graphrag, default: true }
        - { name: --force-reindex, flag: true, default: false }
        - { name: --log-level, default: INFO }
        - { name: --log-file }
        - { name: --verbose, flag: true }
      behavior:
        - GraphRAG初期化（任意）とMCP設定チェックを行い、構造化された提案を生成
    - name: fix-to-pass-tests
      purpose: ローカルテストを実行し、合格までLLM修正を反復適用
      options:
        - { name: --backend, multiple: true, default: [codex], choices: [codex, codex-mcp, gemini, qwen, auggie, claude] }
        - { name: --message-backend, multiple: true, default: --backendと同じ }
        - { name: --gemini-api-key, env: GEMINI_API_KEY }
        - { name: --openai-api-key, env: OPENAI_API_KEY }
        - { name: --openai-base-url, env: OPENAI_BASE_URL }
        - { name: --qwen-use-env-vars/--qwen-use-cli-options, default: true }
        - { name: --qwen-preserve-env/--qwen-clear-env, default: false }
        - { name: --model-gemini }
        - { name: --model-qwen }
        - { name: --model-auggie }
        - { name: --model-claude }
        - { name: --max-attempts, type: int, default: null(エンジン既定を使用) }
        - { name: --enable-graphrag/--disable-graphrag, default: true }
        - { name: --dry-run, flag: true, default: false }
        - { name: --force-reindex, flag: true, default: false }
        - { name: --log-level, default: INFO }
        - { name: --log-file }
        - { name: --verbose, flag: true }
      behavior:
        - scripts/test.sh を実行（pytestを直接呼ばない）
          - 一貫性のある再現可能な環境のために uv ランナーを優先使用
          - uv が利用できない場合はシステムの Python pytest にフォールバック
          - AC_USE_LOCAL_VENV=1 の場合、ローカル venv を任意で起動
          - 依存関係を uv で自動同期機能を常有効化
        - 反復中にLLMが一切編集しない場合はエラーで停止
        - メッセージ生成用バックエンドを別に指定可能
    - name: get-actions-logs
      purpose: GitHub ActionsのジョブURLからエラーブロックを抽出して出力
      options:
        - { name: --url, required: true }
        - { name: --github-token, env: GITHUB_TOKEN }
    - name: auth-status
      purpose: GitHub / Gemini / Qwen / Auggie の認証・CLI有無を表示
  groups:
    - name: graphrag
      description: Neo4j + Qdrant と GraphRAG MCP サーバーの管理
      subcommands:
        - name: start
          options:
            - { name: --wait/--no-wait, default: true }
            - { name: --timeout, type: int, default: 120 }
        - name: stop
          options:
            - { name: --timeout, type: int, default: 60 }
        - name: status
        - name: update-index
          options:
            - { name: --force, flag: true }
            - { name: --repo-path, type: path }
        - name: setup-mcp
          options:
            - { name: --install-dir, default: "~/graphrag_mcp" }
            - { name: --neo4j-uri, default: "bolt://localhost:7687" }
            - { name: --neo4j-user, default: "neo4j" }
            - { name: --neo4j-password, default: "password" }
            - { name: --qdrant-url, default: "http://localhost:6333" }
            - { name: --skip-clone, flag: true }
            - { name: --backends, multiple: true, choices: [codex, gemini, qwen, windsurf] }

features:
  github_automation:
    - 優先度付き候補収集（urgent PR/Issue > マージ可PR > 失敗PR > Issue）
    - サブIssueなしのオープンIssueが5件以上ならIssue処理をスキップ
    - --only（URL/番号）で単体処理
    - main以外のブランチ上では関連PR/Issueを見つけて自動再開
  fix_loop:
    - テスト再実行とLLM修正を成功まで繰り返し
    - 既定の最大試行回数: 30
    - 編集が無かった検知時はエラーで停止
  backends:
    supported: [codex, codex-mcp, gemini, qwen, auggie, claude]
    rotation:
      description: "BackendManagerが構成順にローテーション。同一テストファイルで3連続なら次へ切替"
    message_backend:
      description: メッセージ生成用バックエンドを分離可能
  graphrag_integration:
    auto_setup: true
    mcp_config_check: true
    index_update: CLIで実行可能
  logging:
    library: loguru
    console: カラー表示・プロジェクト相対の file:function:line を表示
    file: ローテーション10MB・保持7日・zip圧縮
  reports:
    path: "~/.auto-coder/{owner_repo}/automation_report_*.json"

config:
  automation_config:
    REPORTS_DIR: "reports"
    TEST_SCRIPT_PATH: "scripts/test.sh"
    MAX_PR_DIFF_SIZE: 2000
    MAX_PROMPT_SIZE: 1000
    MAX_RESPONSE_SIZE: 200
    MAX_FIX_ATTEMPTS: 30
    MAIN_BRANCH: "main"
    SKIP_MAIN_UPDATE_WHEN_CHECKS_FAIL: true
    IGNORE_DEPENDABOT_PRS: false
    FORCE_CLEAN_BEFORE_CHECKOUT: false
    DISABLE_LABELS: false
    SEARCH_GITHUB_ACTIONS_HISTORY: true
    ENABLE_ACTIONS_HISTORY_FALLBACK: true
    MERGE_METHOD: "--squash"
    MERGE_AUTO: true

env:
  GITHUB_TOKEN: GitHub APIトークン
  GEMINI_API_KEY: geminiバックエンド用APIキー
  OPENAI_API_KEY: qwenバックエンド用(OpenAI互換)APIキー
  OPENAI_BASE_URL: qwenバックエンド用(OpenAI互換)Base URL
  AUTO_CODER_QWEN_CONFIG: qwen-providers.toml のフルパス上書き
  AUTO_CODER_CONFIG_DIR: qwen-providers.toml を含むディレクトリ

external_dependencies:
  graphrag:
    services: [neo4j, qdrant]
    docker_compose_file: docker-compose.graphrag.yml
  graphrag_mcp:
    type: "CUSTOMIZED FORK"
    path: "mcp/graphrag_mcp"
    specialized_for: "TypeScript/JavaScript のコード分析"
    tools: [find_symbol, get_call_graph, get_dependencies, impact_analysis, semantic_code_search]
    notes: "汎用ドキュメント検索の代わりに、コード分析ツール群を提供するフォークを同梱"
  qwen_providers_config:
    file: "~/.auto-coder/qwen-providers.toml"
    defaults:
      modelstudio: { base_url: "https://dashscope-intl.aliyuncs.com/compatible-mode/v1", model: "qwen3-coder-plus" }
      openrouter: { base_url: "https://openrouter.ai/api/v1", model: "qwen/qwen3-coder:free" }
    env_override:
      - AUTO_CODER_QWEN_CONFIG
      - AUTO_CODER_CONFIG_DIR

