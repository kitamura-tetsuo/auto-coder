# Bundled MCP Server

## Overview

Starting with auto-coder v2025.10.23, a customized GraphRAG MCP server is bundled with the package.

## Changes

### Previous (before v2025.10.23)

- The `auto-coder graphrag setup-mcp` command cloned `https://github.com/rileylemm/graphrag_mcp`
- Used a generic documentation search MCP server
- Tools: `search_documentation`, `hybrid_search`

### Current (v2025.10.23 and later)

- The `auto-coder graphrag setup-mcp` command copies the bundled custom MCP server
- Uses a TypeScript/JavaScript code analysis dedicated MCP server
- Tools: `find_symbol`, `get_call_graph`, `get_dependencies`, `impact_analysis`, `semantic_code_search`

## Bundled MCP Server Location

### Within Package

```
src/auto_coder/mcp_servers/graphrag_mcp/
├── FORK_INFO.md              # Fork information
├── server.py                 # MCP server main
├── main.py                   # Entry point
├── pyproject.toml            # Dependency definitions
├── run_server.sh             # Startup script
└── graphrag_mcp/
    ├── code_analysis_tool.py # Code analysis tool implementation
    └── documentation_tool.py # Original tool (unused)
```

### After Installation

```bash
# When installed via pipx
pipx install auto-coder

# Copy MCP server with setup-mcp command
auto-coder graphrag setup-mcp

# Default copy destination
~/graphrag_mcp/
```

## Usage

### 1. Install auto-coder

```bash
# Via pipx (recommended)
pipx install auto-coder

# Or via pip
pip install auto-coder
```

### 2. Start GraphRAG Service

```bash
# Start Neo4j + Qdrant
auto-coder graphrag start
```

### 3. Setup MCP Server

#### Automatic Setup (Recommended)

**Starting with v2025.10.23, the MCP server is automatically set up.**

When you run auto-coder, if the `~/graphrag_mcp` directory doesn't exist, automatic setup is executed.

```bash
# Automatic setup is performed just by running normal commands
auto-coder run

# Or any command
auto-coder process-issues
```

#### Manual Setup

If you want to set up manually, run the following commands:

```bash
# Copy bundled MCP server to ~/graphrag_mcp
auto-coder graphrag setup-mcp

# Copy to custom directory
auto-coder graphrag setup-mcp --install-dir /path/to/custom/dir
```

This command performs the following:
1. Copies the bundled MCP server to the specified directory
2. Installs dependencies using `uv`
3. Creates `.env` file (Neo4j/Qdrant connection information)
4. Automatically updates configuration files for each backend (Codex, Gemini, Qwen, Windsurf/Claude)

### 4. Verify MCP Server Startup

```bash
# Manually start MCP server (for testing)
cd ~/graphrag_mcp
uv run main.py

# Or use the startup script
./run_server.sh
```

## Customizations

### Fork Source

- Original: https://github.com/rileylemm/graphrag_mcp
- Purpose: Generic documentation search

### Customizations

1. **Graph Schema Changes**
   - Original: Document, Chunk, Category nodes
   - Current: File, Symbol (Function, Method, Class, Interface, Type) nodes

2. **Relationship Changes**
   - Original: PART_OF, RELATED_TO, HAS_CATEGORY
   - Current: CONTAINS, CALLS, EXTENDS, IMPLEMENTS, IMPORTS

3. **Additional Tools**
   - `find_symbol(fqname)`: Symbol search
   - `get_call_graph(symbol_id, direction, depth)`: Call graph analysis
   - `get_dependencies(file_path)`: Dependency analysis
   - `impact_analysis(symbol_ids, max_depth)`: Impact scope analysis
   - `semantic_code_search(query, limit, kind_filter)`: Semantic code search

4. **Enhanced Self-Description**
   - Added ts-morph specific information to tool docstrings
   - Added code analysis domain knowledge to MCP resources

## Technical Details

### Packaging

- Added MCP server to `pyproject.toml` under `[tool.setuptools.package-data]`
- Explicitly include MCP server files in `MANIFEST.in`
- Automatically bundled during pipx/pip installation

### Setup Flow

```python
# src/auto_coder/cli_commands_graphrag.py

def run_graphrag_setup_mcp_programmatically(...):
    # 1. Search for MCP server within package
    import auto_coder
    package_dir = Path(auto_coder.__file__).parent
    bundled_mcp = package_dir / "mcp_servers" / "graphrag_mcp"

    # 2. Copy to installation destination
    shutil.copytree(bundled_mcp, install_path)

    # 3. Install dependencies
    subprocess.run(["uv", "sync"], cwd=install_path)

    # 4. Create .env file
    # 5. Update backend configuration
```

### Integration with ts-morph

The MCP server corresponds to the graph structure generated by the ts-morph scanner in `src/auto_coder/graph_builder/`:

```typescript
// src/auto_coder/graph_builder/src/types.ts

export type NodeKind = 'File' | 'Function' | 'Method' | 'Class' | 'Interface' | 'Type';
export type EdgeType = 'IMPORTS' | 'CALLS' | 'CONTAINS' | 'EXTENDS' | 'IMPLEMENTS';

export interface CodeNode {
  id: string;
  kind: NodeKind;
  fqname: string;
  sig: string;
  complexity: number;
  file: string;
  start_line: number;
  end_line: number;
  tags?: string[];
}
```

## Troubleshooting

### MCP Server Not Found

```bash
# Verify package is correctly installed
python -c "import auto_coder; from pathlib import Path; print(Path(auto_coder.__file__).parent / 'mcp_servers' / 'graphrag_mcp')"

# Reinstall
pipx reinstall auto-coder
```

### setup-mcp Failure

```bash
# Verify uv is installed
uv --version

# Install uv
curl -LsSf https://astral.sh/uv/install.sh | sh

# Remove existing directory and re-run
rm -rf ~/graphrag_mcp
auto-coder graphrag setup-mcp
```

### MCP Server Won't Start

```bash
# Reinstall dependencies
cd ~/graphrag_mcp
uv sync

# Verify Neo4j/Qdrant are running
auto-coder graphrag status

# Check .env file
cat ~/graphrag_mcp/.env
```

## References

- Fork information: `src/auto_coder/mcp_servers/graphrag_mcp/FORK_INFO.md`
- Feature documentation: `docs/client-features.yaml` (external_dependencies.graphrag_mcp)
- Setup command: `src/auto_coder/cli_commands_graphrag.py`
- Tests: `tests/test_graphrag_mcp_fork.py`

## Future Extensions

1. **Multi-language Support**: Add support for Python, Go, Rust
2. **Advanced Queries**: Architecture analysis, dead code detection
3. **Incremental Updates**: Optimization for large codebases
4. **Caching**: Cache frequent queries
5. **Visualization**: Call graph visualization tools

