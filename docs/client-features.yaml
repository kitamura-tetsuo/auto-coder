version: "2025.11.17+g658f0b9"
project:
  name: auto-coder
  description: Automated application development with multi-backend LLM CLI and GitHub integration
  python: ">=3.11,<3.12"
  entry_point: auto-coder
  repository_paths:
    - "mcp/graphrag_mcp"  # path to bundled GraphRAG MCP fork

cli:
  binary: auto-coder
  commands:
    - name: process-issues
      purpose: Process GitHub issues and PRs using AI backends; optionally only label issues in Jules mode
      options:
        - { name: --repo, type: string, default: auto-detect from current git repo, env: null }
        - { name: --github-token, type: string, env: GITHUB_TOKEN, default: null }
        - { name: --backend, multiple: true, default: [codex], choices: [codex, codex-mcp, gemini, qwen, auggie, claude] }
        - { name: --message-backend, multiple: true, default: same as --backend, choices: [codex, codex-mcp, gemini, qwen, auggie, claude] }
        - { name: --gemini-api-key, env: GEMINI_API_KEY }
        - { name: --openai-api-key, env: OPENAI_API_KEY }
        - { name: --openai-base-url, env: OPENAI_BASE_URL }
        - { name: --qwen-use-env-vars/--qwen-use-cli-options, default: false }
        - { name: --qwen-preserve-env/--qwen-clear-env, default: false }
        - { name: --model-gemini, type: string }
        - { name: --model-qwen, type: string }
        - { name: --model-auggie, type: string }
        - { name: --model-claude, type: string }
        - { name: --jules-mode/--no-jules-mode, default: true }
        - { name: --disable-labels/--no-disable-labels, default: auto-detect (disabled in debugger) }
        - { name: --check-labels/--no-check-labels, default: true, help: "Enable checking for existing @auto-coder label before processing (default: enabled)" }
        - { name: --skip-main-update/--no-skip-main-update, default: true }
        - { name: --ignore-dependabot-prs/--no-ignore-dependabot-prs, default: false, help: "Skip non-ready dependency-bot PRs (Dependabot/Renovate/[bot]); still auto-merge when checks pass and PR is mergeable" }
        - { name: --force-clean-before-checkout/--no-force-clean-before-checkout, default: false }
        - { name: --enable-graphrag/--disable-graphrag, default: true }
        - { name: --only, type: string, help: "PR/Issue URL or number" }
        - { name: --force-reindex, flag: true, default: false }
        - { name: --log-level, choices: [DEBUG, INFO, WARNING, ERROR, CRITICAL], default: INFO }
        - { name: --log-file, type: path }
        - { name: --verbose, flag: true }
      behavior:
            - Initializes GraphRAG when enabled (auto-setup + MCP config check)
            - Resumes work on current non-main branch by detecting an open PR/issue
            - Prioritizes candidates: urgent label (3) > auto-mergeable PRs (2) > failing PRs (1) > issues (0)
            - Skips issues if 5+ open issues without sub-issues are found in a batch
            - Saves JSON reports under ~/.auto-coder/{owner_repo}/
            - Honors skip-main-update policy (default: skip merging base branch before fixes)
            - Check-labels behavior: When CHECK_LABELS is true (default), issues/PRs with @auto-coder label are automatically skipped to prevent duplicate processing
            - When --only flag is specified for single-item processing, CHECK_LABELS is automatically disabled to ensure the target item is processed
    - name: create-feature-issues
      purpose: Analyze repository and create feature enhancement issues via LLM
      options:
        - { name: --repo, type: string, default: auto-detect }
        - { name: --github-token, env: GITHUB_TOKEN }
        - { name: --backend, multiple: true, default: [codex], choices: [codex, codex-mcp, gemini, qwen, auggie, claude] }
        - { name: --disable-labels/--no-disable-labels, default: false }
        - { name: --gemini-api-key, env: GEMINI_API_KEY }
        - { name: --openai-api-key, env: OPENAI_API_KEY }
        - { name: --openai-base-url, env: OPENAI_BASE_URL }
        - { name: --qwen-use-env-vars/--qwen-use-cli-options, default: true }
        - { name: --qwen-preserve-env/--qwen-clear-env, default: false }
        - { name: --model-gemini }
        - { name: --model-qwen }
        - { name: --model-auggie }
        - { name: --model-claude }
        - { name: --enable-graphrag/--disable-graphrag, default: true }
        - { name: --force-reindex, flag: true, default: false }
        - { name: --log-level, default: INFO }
        - { name: --log-file }
        - { name: --verbose, flag: true }
      behavior:
        - Initializes GraphRAG (optional) and checks MCP configuration
        - Uses prompts to propose structured feature issues with labels/acceptance criteria
    - name: fix-to-pass-tests
      purpose: Run local tests and iteratively apply LLM fixes until tests pass
      options:
        - { name: --backend, multiple: true, default: [codex], choices: [codex, codex-mcp, gemini, qwen, auggie, claude] }
        - { name: --message-backend, multiple: true, default: same as --backend }
        - { name: --disable-labels/--no-disable-labels, default: false }
        - { name: --gemini-api-key, env: GEMINI_API_KEY }
        - { name: --openai-api-key, env: OPENAI_API_KEY }
        - { name: --openai-base-url, env: OPENAI_BASE_URL }
        - { name: --qwen-use-env-vars/--qwen-use-cli-options, default: true }
        - { name: --qwen-preserve-env/--qwen-clear-env, default: false }
        - { name: --model-gemini }
        - { name: --model-qwen }
        - { name: --model-auggie }
        - { name: --model-claude }
        - { name: --max-attempts, type: int, default: null (engine default applies) }
        - { name: --enable-graphrag/--disable-graphrag, default: true }
        - { name: --force-reindex, flag: true, default: false }
        - { name: --log-level, default: INFO }
        - { name: --log-file }
        - { name: --verbose, flag: true }
      behavior:
        - Executes scripts/test.sh (never calls pytest directly)
          - Prefers uv runner for consistent, reproducible environments
          - Falls back to system Python's pytest when uv is not available
          - Optionally activates local virtualenv when AC_USE_LOCAL_VENV=1
          - Always enables auto-syncing dependencies with uv
          - Pytest verbosity flags: CI uses -vv for both full runs and single-file reruns; locally, -q for full suite and -v for single-file reruns
          - On full-suite failure, detects the first failed test and re-runs only that file using the configured single-file verbosity flags
        - If LLM makes no edits in an iteration, stops with error
        - Supports separate message backends for summarization/communication
    - name: get-actions-logs
      purpose: Fetch and print error blocks from a GitHub Actions job URL
      options:
        - { name: --url, required: true }
        - { name: --github-token, env: GITHUB_TOKEN }
    - name: auth-status
      purpose: Print authentication and CLI availability status for GitHub, Gemini, Qwen, Auggie
    - name: migrate-branches
      purpose: Migrate existing pr-<number> branches to their corresponding issue-<number> branches
      options:
        - { name: --execute, flag: true, default: false, help: "Actually perform the migration" }
        - { name: --no-delete, flag: true, default: false, help: "Do not delete pr-<number> branches after successful migration" }
        - { name: --force, flag: true, default: false, help: "Auto-resolve merge conflicts (use with caution)" }
      behavior:
        - Scans for all branches matching the pr-<number> pattern
        - For each pr-xx branch, checks if an issue-xx branch exists
        - If issue-xx exists, merges pr-xx into issue-xx
        - If issue-xx doesn't exist, creates it from pr-xx
        - Deletes the pr-xx branch after successful merge (unless --no-delete is used)
        - Safe to run multiple times (idempotent)
  groups:
    - name: graphrag
      description: Manage Neo4j + Qdrant and the GraphRAG MCP server
      subcommands:
        - name: start
          options:
            - { name: --wait/--no-wait, default: true }
            - { name: --timeout, type: int, default: 120 }
        - name: stop
          options:
            - { name: --timeout, type: int, default: 60 }
        - name: status
        - name: update-index
          options:
            - { name: --force, flag: true }
            - { name: --repo-path, type: path }
        - name: cleanup
          options:
            - { name: --dry-run, flag: true }
            - { name: --retention-days, type: int, default: 7 }
            - { name: --max-per-repo, type: int, default: 9 }
            - { name: --repo-path, type: path }
            - { name: --verbose, flag: true }

        - name: setup-mcp
          options:
            - { name: --install-dir, default: "~/graphrag_mcp" }
            - { name: --neo4j-uri, default: "bolt://localhost:7687" }
            - { name: --neo4j-user, default: "neo4j" }
            - { name: --neo4j-password, default: "password" }
            - { name: --qdrant-url, default: "http://localhost:6333" }
            - { name: --skip-clone, flag: true }
            - { name: --backends, multiple: true, choices: [codex, gemini, qwen, windsurf] }
    - name: mcp
      description: Install and inspect MCP servers
      subcommands:
        - { name: setup <server_name>, options: [--install-dir, --force] }
        - { name: list }
        - { name: status <server_name> }
        - { name: test <server_name> }
    - name: mcp-pdb
      description: Helpers for MCP-PDB setup
      subcommands:
        - { name: print-config, options: [--target (windsurf|claude), --write-to] }
        - { name: status }

features:
  github_automation:
    - Candidate collection with priority ordering (urgent PR/Issue > mergeable PRs > failing PRs > issues)
    - Skips issues when 5+ open issues without sub-issues are present
    - Single-item processing via --only (URL or number)
    - Auto-resume when on a non-main branch with an associated PR/Issue
    - label_management: Removed duplicate LabelManager usage from issue processing; LabelManager is now used only for PR processing to prevent concurrent processing. Added thread reentrancy detection to prevent deadlock scenarios in concurrent contexts. Added PR label wrapper methods (add_labels_to_pr/remove_labels_from_pr/has_label_on_pr). Fixed check-only exception handling in LabelManager to fail-open (returns True on error) and added pre-check to skip when label already exists. Ensured remove_labels is always called with the correct item_type ("issue" vs "pr") so GitHub logs and API paths stay consistent.
    - git_operations: "Enhanced git commit/push failure resolution: unknown commit errors trigger LLM remediation; after LLM, code retries commit and treats as success when nothing is left to commit. Push fallback via LLM remains and works even without commit message."
    - branch_creation: "New issue branches are always created from refs/remotes/origin/<default> (default: refs/remotes/origin/main). When create_new=True, base_branch is required; checkout runs 'git fetch origin --prune --tags' and then 'git checkout -B <branch> <resolved-base-ref>' (prefers refs/remotes/origin/<base_branch>, falls back to local). Logs explicitly show the resolved base ref used."
    - ref_handling: "Use fully qualified remote refs (refs/remotes/origin/<branch>) in Git operations to avoid ambiguous 'origin/<branch>' warnings and failures"


  dependency_management:
    - description: Automatic dependency checking for issue processing
    - patterns: Supports "Depends on: #123", "depends on #456", "blocked by #789" patterns (case-insensitive)
    - behavior: Skips issues with unresolved dependencies (dependency issues still open)
    - configurable: CHECK_DEPENDENCIES flag (default: enabled)
    - error_handling: Missing or inaccessible dependency issues are treated as unresolved

  test_timeout:
    - description: "Added pytest-timeout dependency and 60-second timeout to all pytest runs for better test reliability and CI stability"
    - dependency: "pytest-timeout>=2.1.0"
    - configuration:
      - "Added --timeout=60 flag to all pytest commands in scripts/test.sh"
      - "Applies to both full test suite runs and single test file runs"
      - "Prevents tests from hanging indefinitely and improves CI pipeline reliability"

  fix_loop:
    - Re-run tests and apply LLM fixes until success or max attempts
    - Default max attempts (engine): 30
    - No-op edit detection halts the loop with error
    - structured_results: "Test runs produce a TestResult dataclass (success, output, errors, return_code, command, test_file, stability_issue, extraction_context, framework_type)"
    - error_extraction_api: "extract_important_errors now accepts TestResult; preserves multi-framework detection (pytest/Playwright/Vitest) and logs framework_type"
  backends:
    supported: [codex, codex-mcp, gemini, qwen, auggie, claude]
    rotation:
      description: "BackendManager rotates across configured backends; switches after 3 consecutive runs on same test file"
    message_backend:
      description: Separate backends can be used for message generation
  graphrag_integration:
    auto_setup: true
    mcp_config_check: true
    index_update: available via CLI
    snapshot_cleanup:
      retention_days_default: 7
      max_snapshots_per_repo_default: 9
      env_flags:
        - GRAPHRAG_RETENTION_DAYS
        - GRAPHRAG_MAX_SNAPSHOTS_PER_REPO
        - GRAPHRAG_CLEANUP_ON_INIT
        - GRAPHRAG_CLEANUP_ON_UPDATE
      cli_command: "auto-coder graphrag cleanup [--dry-run] [--retention-days N] [--max-per-repo M] [--repo-path PATH]"
      hooks:
        - initialize_graphrag
        - GraphRAGIndexManager.update_index
    pytest_fallback: "Under pytest, GraphRAGIndexManager avoids external graph-builder and uses fast Python fallback indexing"
    docker_manager:
      fallback_recovery: true
      external_network: true
      auto_retry_on_failure: true
  test_watcher:
    playwright_safety:
      - "Skips Playwright execution under pytest or when AC_DISABLE_PLAYWRIGHT=1; returns synthetic report"
      - "Quick availability probe: 'npx playwright --version' with 5s timeout"
      - "Process timeout: 120s communicate() timeout; force-kill on timeout"
    watchdog_daemon: "Observer thread is daemonized; does not block interpreter exit"
    concurrency:
      - "Run-on-change spawns daemon threads for Playwright and GraphRAG update"
      - "GraphRAG retry timers are daemonized"
      - "GraphRAG index updates in TestWatcherTool are scoped to project_root, keeping pytest flows fast on temporary project trees"

  logging:
    library: loguru
    console: colored, includes file:function:line with trimmed project-relative paths
    file: rotation 10 MB, retention 7 days, zip compression
  reports:
    path: "~/.auto-coder/{owner_repo}/automation_report_*.json"

config:
  automation_config:
    REPORTS_DIR: "reports"
    TEST_SCRIPT_PATH: "scripts/test.sh"
    MAX_PR_DIFF_SIZE: 2000
    MAX_PROMPT_SIZE: 1000
    MAX_RESPONSE_SIZE: 200
    MAX_FIX_ATTEMPTS: 30
    MAIN_BRANCH: "main"
    SKIP_MAIN_UPDATE_WHEN_CHECKS_FAIL: true
    IGNORE_DEPENDABOT_PRS: false  # Skip non-ready dependency-bot PRs; still auto-merge when green and mergeable
    FORCE_CLEAN_BEFORE_CHECKOUT: false
    DISABLE_LABELS: false
    CHECK_LABELS: true
    CHECK_DEPENDENCIES: true
    SEARCH_GITHUB_ACTIONS_HISTORY: true
    ENABLE_ACTIONS_HISTORY_FALLBACK: true
    MERGE_METHOD: "--squash"
    MERGE_AUTO: true

env:
  GITHUB_TOKEN: GitHub API token for API and gh CLI operations
  GEMINI_API_KEY: API key for Gemini when using gemini backend
  OPENAI_API_KEY: OpenAI-compatible API key for qwen backend
  OPENAI_BASE_URL: OpenAI-compatible base URL for qwen backend
  AUTO_CODER_QWEN_CONFIG: Override path to qwen-providers.toml
  AUTO_CODER_CONFIG_DIR: Directory that contains qwen-providers.toml
  AC_DISABLE_PLAYWRIGHT: "If set to 1, TestWatcherTool skips Playwright execution and returns a synthetic report (useful in CI)"
  GRAPHRAG_RETENTION_DAYS: "Number of days to retain GraphRAG index snapshots before cleanup (default: 7)"
  GRAPHRAG_MAX_SNAPSHOTS_PER_REPO: "Maximum number of GraphRAG index snapshots to keep per repository (default: 9)"
  GRAPHRAG_CLEANUP_ON_INIT: "Enable automatic GraphRAG snapshot cleanup during initialize_graphrag (default: 1)"
  GRAPHRAG_CLEANUP_ON_UPDATE: "Enable automatic GraphRAG snapshot cleanup after each index update (default: 1)"

changes:
  - date: "2025-11-17"
    version: "2025.11.17+update-backend-config"
    changes:
      - "Updated .vscode/launch.json to enable multiple AI backends (claude, gemini, codex) with their respective models"
      - "Enhanced PR processor to automatically commit and push changes when local tests pass during fix iterations"
      - "Added git_commit_with_retry and git_push calls in _fix_pr_issues_with_testing function for better automation"

external_dependencies:
  graphrag:
    services: [neo4j, qdrant]
    docker_compose_file: docker-compose.graphrag.yml
  graphrag_mcp:
    type: "CUSTOMIZED FORK"
    path: "mcp/graphrag_mcp"
    specialized_for: "TypeScript/JavaScript code analysis"
    tools: [find_symbol, get_call_graph, get_dependencies, impact_analysis, semantic_code_search]
    notes: "Bundled fork replaces generic documentation search with code analysis tools."
  qwen_providers_config:
    file: "~/.auto-coder/qwen-providers.toml"
    defaults:
      modelstudio: { base_url: "https://dashscope-intl.aliyuncs.com/compatible-mode/v1", model: "qwen3-coder-plus" }
      openrouter: { base_url: "https://openrouter.ai/api/v1", model: "qwen/qwen3-coder:free" }
    env_override:
      - AUTO_CODER_QWEN_CONFIG  # full path override
      - AUTO_CODER_CONFIG_DIR   # directory override

