# Auto-Coder Agent Guidelines

## プロジェクト概要
このプロジェクトは、AI CLIバックエンド（デフォルト: codex、--backendでgeminiに切替可）を使用してアプリケーション開発を自動化するPythonアプリケーションです。
GitHubからissueやエラーのPRを取得して構築・修正を行い、必要に応じて機能追加issueを自動作成します。

## 開発ガイドライン

### コード品質
- 全ての機能には対応するテストを作成する
- テストの期待値は厳密に設定する
- テストが失敗した場合は、まずテストの期待値が仕様に一致しているかを確認する
- テストをスキップするコードは禁止
- e2eテストではモックを使用しない
- e2eテストはheadlessで実行する

### プロジェクト構造
- 標準的なPythonプロジェクト構造を維持する
- 機能は全てdocs/client-features.yamlに記載する
- 重複する関数を複数箇所に作成しない

### GitHub操作
- GitHub操作にはghコマンドを使用する
- GitHub APIを適切に使用してissueとPRを取得する

### 依存関係管理
- パッケージ管理にはpipまたはpoetryを使用する
- requirements.txtまたはpyproject.tomlを適切に管理する

### ログ設定
- loguruライブラリを使用してログ出力を行う
- ログにはファイル名、関数名、行番号を含める
- コンソール出力は色付きで見やすく表示する
- ファイル出力はローテーション機能付きで保存する

### LLM実行ポリシー（重要）

- 分析フェーズ禁止: analyze_issue 等、分析だけを目的とした LLM 呼び出しを行わない
- 単回実行: 各 issue/PR につき LLM の実行は1回とし、その1回で修正の特定・実装・テスト・コミット/PR更新までを完結させる
- 分割実行禁止: 同一の LLM に対して複数回に分けてタスクを投げない（精度は向上しないため）
- 例外: Git/GitHub API 呼び出し、ビルド/テスト/静的解析などの非LLM処理は必要に応じて実行可。モデルの自動切替は同一回内でのみ許容
- 実装注意: CodexClient 等のクライアントに analyze_issue などのメソッドを追加・使用しない。既存コードに存在する場合は呼び出しを削除し、単回実行フローに統一する

## 主要機能
- GitHub APIを使用したissue/PR取得（古い順でソート）
- **Jules Mode（オプション）**: issueに'jules'ラベルを追加、PRは通常通りAIバックエンドで処理（デフォルトは codex）
- **通常モード（デフォルト）**: デフォルトの codex または --backend 指定の Gemini を使用した単回実行の自動処理（分析のみの呼び出しは禁止）
- **自動モデル切り替え**: PRコンフリクト時にgemini-2.5-flashに自動切り替えで高速解決
- **Package-lock.jsonコンフリクト特別処理**: package-lock.json、yarn.lock、pnpm-lock.yamlのコンフリクトを自動削除・再生成で解決
- **package.json 依存関係のみのコンフリクト自動解消**: package.jsonの非依存セクションが一致し、依存セクションのみの差分である場合に、より新しいバージョン／より多い方を優先して自動マージ
- **Geminiプロンプトエスケープ**: プロンプト内の@文字を\@に自動エスケープしてGemini CLIに安全に渡す
- 必要な機能の自動検出と issue作成
- 自動化されたコード修正と構築
- PR処理の優先順位付け（GitHub Actionsパス且つマージ可能→マージ、その他→修正）

- LLMスキップ用フラグ導入: package-lock.json等の自動解消やマージ解決後にpush完了した場合、フラグで後続のLLM分析を明示的にスキップ
- Jules ModeはデフォルトON: CLIの --jules-mode/--no-jules-mode で切替（既定はON）

## テスト戦略
- ユニットテスト: 各モジュールの個別機能をテスト
- 統合テスト: API統合とCLI統合をテスト
- e2eテスト: エンドツーエンドの自動化フローをテスト
